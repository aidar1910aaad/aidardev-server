import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { GoogleGenerativeAI } from '@google/generative-ai';

/**
 * Сервис для работы с Gemini API
 * Генерирует статьи блога с помощью AI
 */
@Injectable()
export class GeminiService {
  private genAI: GoogleGenerativeAI;
  private model: any;

  constructor(private configService: ConfigService) {
    const apiKey = this.configService.get<string>('GEMINI_API_KEY');
    
    if (!apiKey) {
      throw new Error('GEMINI_API_KEY is not defined in environment variables');
    }

    this.genAI = new GoogleGenerativeAI(apiKey);
    this.model = this.genAI.getGenerativeModel({ model: 'gemini-2.0-flash' });
  }

  /**
   * Генерация темы для статьи (автоматически)
   */
  async generateTopic(
    language: 'ru' | 'en' | 'kz' = 'ru',
    existingPosts: Array<{ slug: string; title: string; category?: string }> = [],
  ): Promise<string> {
    const languageNames = {
      ru: 'русском',
      en: 'английском',
      kz: 'казахском',
    };

    let existingTopicsInfo = '';
    if (existingPosts.length > 0) {
      // Группируем по категориям для лучшего анализа
      const postsByCategory: Record<string, string[]> = {};
      existingPosts.slice(0, 30).forEach((post: any) => {
        const category = post.category || 'Разное';
        if (!postsByCategory[category]) {
          postsByCategory[category] = [];
        }
        postsByCategory[category].push(post.title);
      });

      const topicsList = Object.entries(postsByCategory)
        .map(([category, titles]) => {
          return `${category}:\n${titles.map((t) => `  - ${t}`).join('\n')}`;
        })
        .join('\n\n');

      existingTopicsInfo = `

Уже написаны следующие статьи (КРИТИЧЕСКИ ВАЖНО: избегай этих тем и похожих!):
${topicsList}

АНАЛИЗ:
- Проанализируй, какие категории УЖЕ использованы больше всего
- Выбери категорию, которая используется МЕНЬШЕ всего
- Убедись, что новая тема НЕ похожа на существующие (не используй те же ключевые слова)`;
    }

    const prompt = `Ты опытный контент-маркетолог и SEO-специалист, который понимает психологию бизнеса и знает, как мотивировать предпринимателей к действию.

Задача: Придумай ХАЙПОВУЮ и МОТИВИРУЮЩУЮ тему для статьи блога, которая заставит бизнесмена подумать "Блин, надо это внедрить!" ВАЖНО: Выбирай темы РАЗНООБРАЗНО из разных категорий!

Контекст:
- Сайт: aidardev.kz - портфолио Full-Stack разработчика
- География: Казахстан (Алматы, Астана, Шымкент)
- Услуги: веб-разработка, создание сайтов, интернет-магазины, Telegram-боты, WhatsApp-боты, AI-интеграции, мобильные приложения, UI/UX дизайн
- Целевая аудитория: бизнес-владельцы, предприниматели, стартапы в Казахстане${existingTopicsInfo}

КАТЕГОРИИ ДЛЯ ВЫБОРА ТЕМ (ВЫБИРАЙ РАЗНООБРАЗНО!):
1. "Маркетинг и SEO" - SEO-оптимизация, контент-маркетинг, конверсия, трафик, реклама
2. "Веб-разработка" - технологии разработки, фреймворки, производительность, безопасность, API
3. "Бизнес" - автоматизация, эффективность, стартапы, финансирование, масштабирование
4. "Технологии" - AI, машинное обучение, новые технологии, тренды, инновации
5. "Дизайн" - UI/UX дизайн, пользовательский опыт, визуальное оформление, типографика

КРИТИЧЕСКИ ВАЖНО - Тема должна быть:
1. УНИКАЛЬНОЙ - НЕ дублировать темы из списка существующих статей выше! Проверь каждую существующую тему и убедись, что новая тема кардинально отличается
2. ХАЙПОВОЙ и АКТУАЛЬНОЙ - про то, что сейчас в тренде, что обсуждают, что работает
3. РЕШАТЬ РЕАЛЬНУЮ БОЛЬ - проблему, которая реально существует у бизнеса в Казахстане
4. ПОКАЗЫВАТЬ ВЫГОДУ - экономию времени, денег, рост продаж, конкурентное преимущество
5. МОТИВИРОВАТЬ К ДЕЙСТВИЮ - заставлять думать "это надо внедрить", "это решит мою проблему"
6. БЫТЬ ПРАКТИЧНОЙ - конкретные советы, кейсы, примеры, а не теория
7. ПРИВЯЗАНА К КАЗАХСТАНУ - учитывать локальный рынок, платежные системы, менталитет
8. РАЗНООБРАЗНОЙ ПО КАТЕГОРИИ - анализируй, какие категории уже использованы, и выбирай ДРУГУЮ категорию, если возможно

Ответь ТОЛЬКО темой статьи на ${languageNames[language]} языке, без дополнительных объяснений. Тема должна быть 5-12 слов, привлекательной, конкретной и "цепляющей".

Примеры ХАЙПОВЫХ тем, которые мотивируют к действию (используй как ориентир):

Маркетинг и SEO:
- "Как увеличить продажи на 30% за месяц: секреты конверсионного сайта"
- "SEO-трафик бесплатно: как выйти в топ Google за 3 месяца"
- "Где теряются клиенты: 7 причин низкой конверсии и как их исправить"
- "Таргетированная реклама: как получать клиентов дешевле конкурентов"

Веб-разработка:
- "Сайт за 1 день: как запустить бизнес онлайн быстро и без ошибок"
- "Скорость сайта = деньги: как ускорить загрузку и увеличить продажи на 40%"
- "Автоматизация продаж: как сайт может работать на вас 24/7"
- "Мобильная версия: почему 60% клиентов уходят к конкурентам"

Бизнес:
- "Автоматизация рутины: как сэкономить 20 часов в неделю и сфокусироваться на росте"
- "Интернет-магазин с нуля: как начать продавать онлайн за неделю"
- "Клиентская база в смартфоне: как управлять клиентами без CRM"
- "Увеличение прибыли на 50%: как автоматизация меняет бизнес"

Технологии:
- "AI-бот для продаж: как автоматизировать 80% общения с клиентами"
- "ChatGPT для бизнеса: как сэкономить на контенте и рекламе"
- "Автоответчик на WhatsApp: как обрабатывать заказы без менеджера"
- "Искусственный интеллект в бизнесе: как конкуренты обгоняют вас с помощью AI"

Дизайн:
- "Дизайн, который продает: как сайт превращает посетителей в клиентов"
- "Первый клик решает: как дизайн влияет на доверие и продажи"
- "Мобильный дизайн: почему 70% клиентов уходят, если сайт неудобен"
- "UI/UX как конкурентное преимущество: как обогнать конкурентов дизайном"`;

    try {
      const result = await this.model.generateContent(prompt);
      const response = await result.response;
      const text = response.text().trim();
      return text;
    } catch (error: any) {
      throw new Error(`Failed to generate topic: ${error.message}`);
    }
  }

  /**
   * Генерация статьи блога на заданную тему
   * @param topic - Тема статьи
   * @param language - Язык генерации
   * @param existingPosts - Список существующих статей для избежания дубликатов
   */
  async generateBlogPost(
    topic: string,
    language: 'ru' | 'en' | 'kz' = 'ru',
    existingPosts?: Array<{ slug: string; title: string; category?: string }>,
  ) {
    const prompt = this.buildPrompt(topic, language, existingPosts || []);

    try {
      const result = await this.model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();

      // Парсим JSON из ответа
      return this.parseGeneratedContent(text);
    } catch (error: any) {
      throw new Error(`Failed to generate blog post: ${error.message}`);
    }
  }

  /**
   * Построение промпта для генерации статьи
   */
  private buildPrompt(
    topic: string,
    language: string,
    existingPosts: Array<{ slug: string; title: string; category?: string }> = [],
  ): string {
    const languageNames = {
      ru: 'русском',
      en: 'английском',
      kz: 'казахском',
    };

    const today = new Date().toISOString().split('T')[0];

    // Формируем информацию о существующих статьях
    let existingPostsInfo = '';
    if (existingPosts.length > 0) {
      const postsList = existingPosts
        .map((post, index) => `${index + 1}. "${post.title}" (slug: ${post.slug})`)
        .join('\n');
      existingPostsInfo = `

СУЩЕСТВУЮЩИЕ СТАТЬИ В БЛОГЕ:
Уже написаны следующие статьи (избегай дублирования тем и содержания):
${postsList}

ВАЖНО: 
- НЕ создавай статью, которая дублирует темы из списка выше
- Выбери УНИКАЛЬНЫЙ угол раскрытия темы "${topic}", отличный от существующих статей
- Если тема похожа на существующую, сфокусируйся на другом аспекте или подтексте
- Используй уникальный slug, который не совпадает с существующими`;
    }

    return `Ты опытный копирайтер, SEO-специалист и контент-маркетолог с глубокими знаниями в области digital-маркетинга, веб-разработки, бизнеса и технологий. Специализируешься на создании SEO-оптимизированного контента для рынка Казахстана.

КОНТЕКСТ ПРОЕКТА:
- Сайт: aidardev.kz - портфолио Full-Stack разработчика
- География: Казахстан (Алматы, Астана, Шымкент, по всему Казахстану)
- Услуги: веб-разработка, создание сайтов, интернет-магазины, Telegram-боты, WhatsApp-боты, AI-интеграции, мобильные приложения, UI/UX дизайн, консультации
- Опыт: 6+ лет, 47+ проектов
- Целевая аудитория: бизнес-владельцы, предприниматели, стартапы в Казахстане${existingPostsInfo}

Создай увлекательную, информативную и практически полезную SEO-оптимизированную статью для блога на тему: "${topic}"

ВАЖНО О ДАТАХ:
- НЕ упоминай конкретные годы (2024, 2025, 2026 и т.д.) в тексте статьи
- Используй фразы типа: "сегодня", "в настоящее время", "сейчас", "в наши дни", "современные"
- Дата публикации будет установлена автоматически, не включай год в контент

ТРЕБОВАНИЯ К СТАТЬЕ:
1. Контент должен быть уникальным, интересным и ценным для читателя
2. Статья должна решать реальную проблему или отвечать на важный вопрос целевой аудитории
3. Используй реальные примеры, кейсы и практические советы, релевантные для рынка Казахстана
4. Структурируй контент с помощью подзаголовков (h2, h3) для лучшей читаемости и SEO
5. Добавь списки (ul, ol) где это уместно для лучшей читаемости
6. Используй простой и понятный язык, избегай сложных терминов без объяснений
7. Статья должна быть максимально оптимизирована для SEO (естественное использование ключевых слов)
8. Длина контента: 2000-3000 слов (оптимально для SEO)
9. Все тексты должны быть на ${languageNames[language]} языке
10. Фокусируйся на хайповых и актуальных темах, которые интересны людям, ищущим услуги веб-разработки

SEO ОПТИМИЗАЦИЯ (КРИТИЧЕСКИ ВАЖНО):
1. КЛЮЧЕВЫЕ СЛОВА:
   - Естественно используй ключевые слова по теме статьи
   - Включай географические ключевые слова: "Казахстан", "Алматы", "Астана", "Шымкент", "по всему Казахстану"
   - Используй ключевые слова по услугам: "веб-разработка", "разработка сайтов", "создание сайтов", "интернет-магазин", "Telegram-бот", "WhatsApp-бот", "AI-интеграция", "мобильное приложение", "UI/UX дизайн"
   - Включай длинные ключевые фразы: "разработка сайтов Казахстан", "создание сайтов Алматы", "веб-разработка Астана"
   - Плотность ключевых слов: 1-2% (естественное использование, не переспам)

2. ЗАГОЛОВКИ И СТРУКТУРА:
   - H1 (title): 50-70 символов, содержит главное ключевое слово
   - H2: каждый раздел должен иметь подзаголовок с ключевыми словами
   - H3: для подразделов внутри H2
   - Используй ключевые слова в первых 100 словах статьи
   - Используй ключевые слова в подзаголовках

3. МЕТА-ОПИСАНИЯ:
   - Description: 150-160 символов, содержит ключевые слова и призыв к действию
   - Excerpt: 200-250 символов, интересное описание для карточки статьи

4. ВНУТРЕННИЕ ССЫЛКИ:
   - Естественно упоминай услуги и добавляй контекстные ссылки (в HTML используй теги <a>)
   - Примеры ссылок на услуги:
     * <a href="/${language}/services/websites">разработка сайтов</a>
     * <a href="/${language}/services/bots">создание Telegram-ботов</a>
     * <a href="/${language}/services/ai">AI-интеграции</a>
     * <a href="/${language}/services/mobile">мобильные приложения</a>
     * <a href="/${language}/services/design">UI/UX дизайн</a>
   - Добавь 3-5 естественных внутренних ссылок на услуги в тексте статьи
   - Ссылки должны быть релевантными контексту

5. ГЕОГРАФИЧЕСКИЕ УПОМИНАНИЯ:
   - Обязательно упоминай города: Алматы, Астана, Шымкент
   - Упоминай "по всему Казахстану" где уместно
   - Используй фразы: "в Казахстане", "для казахстанского бизнеса", "на рынке Казахстана"

6. КОНТЕНТ ДЛЯ ПОИСКОВЫХ СИСТЕМ:
   - Используй синонимы и связанные термины
   - Отвечай на вопросы пользователей (FAQ формат в тексте)
   - Включай практические примеры и кейсы
   - Добавляй статистику и данные (если релевантно)

СТРУКТУРА СТАТЬИ:
- Вступление (200-300 слов): зацепи читателя, объясни почему тема важна, упомяни ключевые слова
- Основная часть (1500-2200 слов): 4-6 разделов с подзаголовками (h2), раскрывающих тему
  * Каждый раздел должен иметь подзаголовок с ключевыми словами
  * Используй подподзаголовки (h3) для детализации
  * Добавляй списки, примеры, кейсы
- Практические советы/примеры (300-400 слов): конкретные рекомендации
- Заключение (200-300 слов): краткое резюме, призыв к действию, упоминание услуг

КАТЕГОРИИ СТАТЕЙ:
Выбери подходящую категорию из списка:
- "Маркетинг и SEO" - для статей о маркетинге, SEO, конверсии, трафике
- "Веб-разработка" - для статей о разработке сайтов, технологиях, лучших практиках
- "Бизнес" - для статей о бизнесе, автоматизации, эффективности
- "Технологии" - для статей о AI, новых технологиях, трендах
- "Дизайн" - для статей о UI/UX дизайне, визуальном оформлении

КЛЮЧЕВЫЕ СЛОВА ПО УСЛУГАМ (используй естественно в тексте):
- Веб-разработка: "разработка сайтов", "создание сайтов", "веб-разработка", "разработка сайтов Казахстан", "создание сайтов Алматы", "веб-разработка Астана"
- Боты: "Telegram-бот", "WhatsApp-бот", "создание ботов", "Telegram-бот Казахстан", "WhatsApp-бот Алматы"
- AI: "AI-интеграция", "искусственный интеллект", "GPT интеграция", "AI-чатбот", "AI-интеграция Казахстан"
- Мобильные приложения: "мобильное приложение", "разработка мобильных приложений", "iOS приложение", "Android приложение", "мобильное приложение Казахстан"
- Дизайн: "UI/UX дизайн", "веб-дизайн", "дизайн интерфейса", "UI/UX дизайн Казахстан", "веб-дизайн Алматы"
- Консультации: "консультации по разработке", "технические консультации", "обучение программированию"

ФОРМАТ ОТВЕТА (строго валидный JSON, без markdown блоков, без дополнительного текста до или после):
ВАЖНО: JSON должен быть полностью валидным! Все символы новой строки, табуляции и кавычки внутри строковых значений должны быть экранированы (\\n, \\t, \\").

{
  "slug": "url-friendly-slug-topic",
  "title": {
    "ru": "Привлекательный и информативный заголовок на русском с ключевыми словами (50-70 символов)",
    "en": "Engaging and informative title in English with keywords (50-70 characters)",
    "kz": "Тартымды және ақпараттық тақырып қазақ тілінде кілт сөздермен (50-70 символ)"
  },
  "description": {
    "ru": "Мета-описание для SEO, привлекающее клики, с ключевыми словами и географией (150-160 символов, с призывом к действию)",
    "en": "SEO meta description, engaging for clicks, with keywords and geography (150-160 characters, with call to action)",
    "kz": "SEO үшін мета-сипаттама, басылымдарды тарту үшін, кілт сөздермен және географиямен (150-160 символ, әрекетке шақырумен)"
  },
  "excerpt": {
    "ru": "Краткое описание для карточки статьи, которое заинтересует читателя, с упоминанием ключевых слов (200-250 символов)",
    "en": "Short description for article card that interests the reader, with keywords (200-250 characters)",
    "kz": "Оқырманды қызықтыратын мақала карточкасының қысқаша сипаттамасы, кілт сөздермен (200-250 символ)"
  },
  "category": {
    "ru": "Маркетинг и SEO",
    "en": "Marketing & SEO",
    "kz": "Маркетинг және SEO"
  },
  "date": "${today}",
  "keywords": {
    "ru": ["ключевое слово 1", "ключевое слово 2", "ключевое слово 3", "ключевое слово Казахстан", "ключевое слово Алматы", "ключевое слово Астана", "веб-разработка", "разработка сайтов"],
    "en": ["keyword 1", "keyword 2", "keyword 3", "keyword Kazakhstan", "keyword Almaty", "keyword Astana", "web development", "website development"],
    "kz": ["кілт сөз 1", "кілт сөз 2", "кілт сөз 3", "кілт сөз Қазақстан", "кілт сөз Алматы", "кілт сөз Астана", "веб-дамыту", "сайт әзірлеу"]
  },
  "readingTime": 12,
  "published": true,
  "content": {
    "ru": "<h2>Подзаголовок раздела с ключевыми словами</h2><p>Абзац с информацией, естественно используя ключевые слова. Упоминай города: Алматы, Астана, Шымкент. Добавляй внутренние ссылки: <a href=\"/ru/services/websites\">разработка сайтов</a> для казахстанского бизнеса.</p><h3>Подподзаголовок</h3><ul><li>Элемент списка с практическим советом</li><li>Еще один элемент с примером</li></ul><p>Еще один абзац с информацией и упоминанием услуг...</p>",
    "en": "<h2>Section subtitle with keywords</h2><p>Paragraph with information, naturally using keywords. Mention cities: Almaty, Astana, Shymkent. Add internal links: <a href=\"/en/services/websites\">web development</a> for Kazakhstan business.</p><h3>Sub-subtitle</h3><ul><li>List item with practical advice</li><li>Another item with example</li></ul><p>Another paragraph with information and service mentions...</p>",
    "kz": "<h2>Бөлім ішкі тақырыбы кілт сөздермен</h2><p>Ақпаратпен абзац, кілт сөздерді табиғи түрде пайдалана отырып. Қалаларды ата: Алматы, Астана, Шымкент. Ішкі сілтемелерді қос: <a href=\"/kz/services/websites\">веб-дамыту</a> Қазақстан бизнесі үшін.</p><h3>Ішкі ішкі тақырып</h3><ul><li>Практикалық кеңеспен тізім элементі</li><li>Мысалмен тағы бір элемент</li></ul><p>Ақпаратпен және қызметтерді атап өтумен тағы бір абзац...</p>"
  }
}

ВАЖНЫЕ ПРАВИЛА:
- slug: только латиница, дефисы, без пробелов и спецсимволов, SEO-friendly
- title: привлекательный заголовок с главным ключевым словом, 50-70 символов
- description: продающий текст с ключевыми словами и географией, 150-160 символов, с призывом к действию
- excerpt: краткое, но интересное описание с ключевыми словами, 200-250 символов
- category: выбери подходящую категорию (Маркетинг и SEO, Веб-разработка, Бизнес, Технологии, Дизайн)
- keywords: 8-12 релевантных ключевых слов/фраз, включая географические (Казахстан, Алматы, Астана) и по услугам
- readingTime: рассчитай на основе длины контента (примерно 200 слов = 1 минута)
- content: валидный HTML с h2, h3, p, ul, ol, strong, em, a тегами
  * Обязательно используй внутренние ссылки на услуги (3-5 ссылок)
  * Упоминай города: Алматы, Астана, Шымкент
  * Используй ключевые слова естественно в тексте
  * Структурируй контент с подзаголовками
  * НЕ упоминай конкретные годы (2024, 2025, 2026) - используй "сегодня", "сейчас", "в настоящее время"
- Все тексты на ${languageNames[language]} языке

ПРИМЕРЫ КЛЮЧЕВЫХ СЛОВ ДЛЯ РАЗНЫХ ТЕМ:
- Если тема про сайты: "разработка сайтов Казахстан", "создание сайтов Алматы", "веб-разработка Астана", "интернет-магазин Казахстан"
- Если тема про боты: "Telegram-бот Казахстан", "WhatsApp-бот Алматы", "создание ботов Астана"
- Если тема про AI: "AI-интеграция Казахстан", "GPT интеграция", "AI-чатбот Алматы"
- Если тема про мобильные приложения: "мобильное приложение Казахстан", "iOS приложение Алматы", "Android приложение Астана"
- Если тема про дизайн: "UI/UX дизайн Казахстан", "веб-дизайн Алматы", "дизайн интерфейса Астана"

Тема статьи: "${topic}"
Язык: ${language}
Сегодняшняя дата: ${today}
География: Казахстан (Алматы, Астана, Шымкент, по всему Казахстану)`;
  }

  /**
   * Парсинг сгенерированного контента из JSON
   */
  private parseGeneratedContent(text: string): any {
    let jsonText = text.trim();

    // Убираем markdown код блоки если есть
    const jsonMatch = jsonText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
    if (jsonMatch) {
      jsonText = jsonMatch[1].trim();
    }

    // Если не нашли код блок, пытаемся найти JSON объект по первой { и последней }
    const firstBrace = jsonText.indexOf('{');
    const lastBrace = jsonText.lastIndexOf('}');
    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
      jsonText = jsonText.substring(firstBrace, lastBrace + 1);
    }

    // Исправляем неэкранированные управляющие символы в строках
    jsonText = this.fixJsonControlCharacters(jsonText);

    try {
      // Парсим JSON
      const parsed = JSON.parse(jsonText);

      // Валидация структуры
      if (!parsed.slug || !parsed.title || !parsed.content) {
        throw new Error('Invalid generated content structure');
      }

      return parsed;
    } catch (error: any) {
      throw new Error(
        `Failed to parse generated content: ${error.message}. Raw text preview: ${text.substring(0, 500)}`,
      );
    }
  }

  /**
   * Исправление неэкранированных управляющих символов в JSON строках
   * Использует простой подход: заменяет неэкранированные \n, \r, \t внутри строковых значений
   */
  private fixJsonControlCharacters(jsonText: string): string {
    let result = '';
    let inString = false;
    let escapeNext = false;

    for (let i = 0; i < jsonText.length; i++) {
      const char = jsonText[i];

      if (escapeNext) {
        result += char;
        escapeNext = false;
        continue;
      }

      if (char === '\\') {
        result += char;
        escapeNext = true;
        continue;
      }

      if (char === '"') {
        inString = !inString;
        result += char;
        continue;
      }

      if (inString) {
        // Внутри строки: экранируем управляющие символы
        if (char === '\n') {
          result += '\\n';
        } else if (char === '\r') {
          result += '\\r';
        } else if (char === '\t') {
          result += '\\t';
        } else {
          result += char;
        }
      } else {
        result += char;
      }
    }

    return result;
  }
}

